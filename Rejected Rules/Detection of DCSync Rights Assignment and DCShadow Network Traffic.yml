title: Detection of DCSync Rights Assignment and DCShadow Network Traffic
id: 2c99737c-585d-4431-b61a-c911d86ff32f
status: Developed
description: Detects modifications to AD security descriptors that grant DCSync rights and monitors network traffic patterns associated with DCSync and DCShadow attacks.
author: Danish Kumar
date: 2024-11-14

references:
  - https://specterops.io/wp-content/uploads/sites/3/2022/06/an_ace_up_the_sleeve.pdf
  - https://blog.nviso.eu/2021/11/15/detecting-dcsync-and-dcshadow-network-traffic/

logsource:
  product: windows
  service: security
  definition: 'Requirements: "Audit Directory Service Changes" must be enabled, and SACLs must be configured on AD objects to generate these events. This policy should cover Windows event IDs 5136, 5137, 5138, 5139, and 5141, as well as Sysmon event IDs 1 and 13.'

detection:
  # Detection of Security Descriptor Modifications for DCSync Rights
  dcsync_rights_assignment:
    EventID:
      - 5136    # Windows Directory Service Change: Modification
      - 13      # Sysmon Registry Modification (if configured)
    AttributeLDAPDisplayName: 'ntSecurityDescriptor'
    AttributeValue|contains:
      - '1131f6ad-9c07-11d1-f79f-00c04fc2dcd2'  # DS-Replication-Get-Changes
      - '1131f6aa-9c07-11d1-f79f-00c04fc2dcd2'  # DS-Replication-Get-Changes-All
      - '89e95b76-444d-4c62-991a-0facbeda640c'  # DS-Replication-Get-Changes-In-Filtered-Set
    filter_main_dns_object_class:
      ObjectClass:
        - 'dnsNode'
        - 'dnsZoneScope'
        - 'dnsZone'

  # Detection of DCSync and DCShadow Network Traffic Pattern
  dcsync_dcshadow_traffic:
    EventID:
      - 5156    # Windows Filtering Platform (WFP) Allowed Connection
      - 3       # Sysmon Network Connection
    SourceIp|contains: '<INTERNAL_IP_RANGE>'  # Replace with organization’s internal IP range
    DestinationPort:
      - 135     # RPC for replication traffic
      - 137     # NetBIOS for replication traffic
      - 139     # NetBIOS Session Service
      - 389     # LDAP
      - 445     # SMB
      - 636     # LDAPS
      - 3268    # Global Catalog LDAP
      - 3269    # Global Catalog LDAPS

  condition: dcsync_rights_assignment and not filter_main_dns_object_class or dcsync_dcshadow_traffic

falsepositives:
  - New Domain Controller account; check user SIDs within event 5136 and verify if it’s a regular user or DC computer account.
  - Legitimate internal network replication traffic for authorized applications.

level: high
tags:
  - attack.persistence
  - attack.t1098
  - attack.credential-access
  - attack.t1003.006

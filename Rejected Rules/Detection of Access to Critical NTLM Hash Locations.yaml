title: Detection of Access to Critical NTLM Hash Locations
id: 123e4567-e89b-12d3-a456-426614174001
status: Developed
description: |
  Detects unauthorized access to sensitive locations storing NTLM hashes, such as the SAM database, NTDS.dit, LSASS process memory, and cached credentials.
author: Danish Kumar
date: 2024-11-13
references:
  - https://github.com/eladshamir/Internal-Monologue
  - https://dev.to/tilakupadhyay/credential-dumping-ntlm-hash-detection-and-prevention-2ihn
  - https://www.cyberark.com/resources/threat-research-blog/detecting-pass-the-hash-with-windows-event-viewer

logsource:
  category: process_creation
  product: windows
  sysmon: true

detection:
  selection:
    # Event ID 11 - File creation or access
    SysmonEventID: 11
    ObjectName|contains:
      - 'C:\\Windows\\System32\\config\\SAM'          # SAM database (local user hashes)
      - 'C:\\Windows\\NTDS\\ntds.dit'                # Active Directory database (domain hashes)
      - 'C:\\Windows\\System32\\lsass.exe'           # LSASS process memory dump attempt
    AccessMask|contains:
      - '0x2'                         # Attempt to read the object (access)
      - '0x4'                         # Attempt to modify the object
      - '0x8'                         # Attempt to execute (could be relevant if dumping or modifying objects)
    IntegrityLevel: high            # Elevated privileges required to access sensitive objects
  condition: selection

fields:
  - User                             # Identifies the user who executed the command
  - ProcessId                        # Unique process ID for tracking
  - ParentProcessId                  # Parent process ID for process hierarchy
  - Image                            # Path of the executable in process creation events
  - CommandLine                      # Full command line for understanding arguments used in credential dumping
  - ObjectName                       # Name of the accessed object (SAM, NTDS, LSASS, etc.)
  - AccessMask                       # Type of access attempted (read/write/execute)
  - Timestamp                        # Event timestamp for timeline reconstruction

level: high
tags:
  - attack.credential-access
  - attack.t1003.001
  - attack.t1003
  - attack.execution

falsepositives:
  - Legitimate administrative access to SAM, NTDS.dit, or LSASS during maintenance activities
  - Accessing cached credentials in a legitimate way by local administrators
  - Legitimate tools being used for backup or system troubleshooting

mitre:
  - Tactic: credential-access
  - Technique: T1003.001 (LSASS Memory Dumping)
  - Sub-technique: T1003

title: File Decoded From Base64 or Hex Via Certutil
description: Detects the execution of certutil with either the "decode" or "decodehex" flags to decode base64 or hex encoded files. This can be abused by attackers to decode an encoded payload before execution
status: Experimental
author: Amr Ashraf
date: 2024/11/09
tags:
    - attack.defense-evasion
    - attack.t1027
logsource:
    category: process_creation
    product: windows
detection:
    process_creation:
        EventID: 4688
        Channel: Security
    selection_img:
        - NewProcessName|endswith: \certutil.exe
    selection_cli:
        CommandLine|contains|windash:
            - '-decode ' # Decode Base64
            - '-decodehex ' # Decode Hex
    VQL:
        LET ID_1182 = (
            (NewProcessName =~ "\\certutil\\.exe$") AND
            (CommandLine =~ "(?=.*-decode |.*-decodehex )")
        )
    condition: process_creation and (all of selection_*)
falsepositives:
    - Unknown
level: medium

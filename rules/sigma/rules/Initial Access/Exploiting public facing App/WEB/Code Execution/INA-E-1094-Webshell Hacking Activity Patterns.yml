title: Webshell Hacking Activity Patterns
description: |
    Detects certain parent child patterns found in cases in which a web shell is used to perform certain credential dumping or exfiltration activities on a compromised system
status: Experimental
author: Amr Ashraf
date: 2024/11/09
tags:
    - attack.persistence
    - attack.t1505.003
    - attack.t1018
    - attack.t1033
    - attack.t1087
logsource:
    category: process_creation
    product: windows
detection:
    process_creation:
        EventID: 4688
        Channel: Security
    selection_webserver_image:
        ParentProcessName|endswith:
            - \caddy.exe
            - \httpd.exe
            - \nginx.exe
            - \php-cgi.exe
            - \w3wp.exe
            - \ws_tomcatservice.exe
    selection_webserver_characteristics_tomcat1:
        ParentProcessName|endswith:
            - \java.exe
            - \javaw.exe
        ParentProcessName|contains:
            - -tomcat-
            - \tomcat
    selection_webserver_characteristics_tomcat2:
        CommandLine|contains:
            - catalina.jar
            - CATALINA_HOME
    # Suspicious child processes
        ParentProcessName|endswith:
            - \java.exe
            - \javaw.exe
    selection_child_1:
        # Process dumping
        CommandLine|contains|all:
            - rundll32
            - comsvcs
    selection_child_2:
        # Winrar exfil
        CommandLine|contains|all:
            - ' -hp'
            - ' a '
            - ' -m'
    selection_child_3:
        # User add
        CommandLine|contains|all:
            - net
            - ' user '
            - ' /add'
    selection_child_4:
        CommandLine|contains|all:
            - net
            - ' localgroup '
            - ' administrators '
            - /add
    selection_child_5:
        NewProcessName|endswith:
            # Credential stealing
            - \ntdsutil.exe
            # AD recon
            - \ldifde.exe
            - \adfind.exe
            # Process dumping
            - \procdump.exe
            - \Nanodump.exe
            # Destruction / ransom groups
            - \vssadmin.exe
            - \fsutil.exe
    selection_child_6:
        # SUspicious patterns
        CommandLine|contains|re:
            - ' -decode '  # Used with certutil
            - ' -NoP '  # Often used in malicious PowerShell commands
            - ' -W *Hidden '  # Often used in malicious PowerShell commands
            - ' /decode '  # Used with certutil
            - ' /ticket:'  # Rubeus
            - ' sekurlsa'  # Mimikatz
            - '.dmp *full'    # Process dumping method apart from procdump
            - .downloadfile(    # PowerShell download command
            - .downloadstring(    # PowerShell download command
            - FromBase64String   # PowerShell encoded payload
            - 'process *call *create'   # WMIC process creation
            - 'reg *save '  # save registry SAM - syskey extraction
            - 'whoami'
    condition: process_creation and (1 of selection_webserver_* and 1 of selection_child_*)
VQL:
  LET ID_1094 = (
      (ParentProcessName =~ "(?=.*\\caddy\\.exe$|.*\\httpd\\.exe$|.*\\nginx\\.exe$|.*\\php-cgi\\.exe$|.*\\w3wp\\.exe$|.*\\ws_tomcatservice\\.exe$)" OR
      (ParentProcessName =~ "(?=.*\\java\\.exe$|.*\\javaw\\.exe$)" AND ParentProcessName =~ "(?=.*-tomcat-|.*\\tomcat)") OR
      CommandLine =~ "(?=.*catalina\\.jar|.*CATALINA_HOME)") AND
      (CommandLine =~ "(?=.*rundll32)(?=.*comsvcs)" OR
      CommandLine =~ "(?=.* -hp)(?=.* a )(?=.* -m)" OR
      CommandLine =~ "(?=.*net)(?=.* user )(?=.* /add)" OR
      CommandLine =~ "(?=.*net)(?=.* localgroup )(?=.* administrators )(?=.* /add)" OR
      NewProcessName =~ "(?=.*\\ntdsutil\\.exe$|.*\\ldifde\\.exe$|.*\\adfind\\.exe$|.*\\procdump\\.exe$|.*\\Nanodump\\.exe$|.*\\vssadmin\\.exe$|.*\\fsutil\\.exe$)" OR
      CommandLine =~ "(?=.* -decode |.* -NoP |.* -W *Hidden |.* /decode |.* /ticket:|.* sekurlsa|.*\\.dmp *full|.*\\.downloadfile\\(|.*\\.downloadstring\\(|.*FromBase64String|.*process *call *create|.*reg *save |.*whoami)"
  )
falsepositives:
    - Unlikely
level: high


title: Enhanced Detection of Adversary-in-the-Middle (AiTM) Techniques on Windows
id: windows-aitm-enhanced-detection-001
status: experimental
description: Detects AiTM techniques on Windows systems, covering unauthorized network service creation, suspicious DNS/LLMNR configurations, network-related commands, outbound connections to high-risk ports, and AiTM tool artifacts.
author: Danish Kumar
date: 2024-11-14

references:
  - https://attack.mitre.org/techniques/T1557/
  - https://www.crowdstrike.com/epp-aim-positioning-attacks
  - https://aws.amazon.com/security/mirroring-for-vpc/

logsource:
  category: process_creation, registry_event, network_connection
  product: windows

detection:
  # Detection 1: Unauthorized Network Service Creation (Windows Event ID 7045, 4697, Sysmon Event ID 1)
  service_creation:
    EventID:
      - 7045     # Windows Service Creation
      - 4697     # Windows Security Event for Service Installation
      - 1        # Sysmon Process Creation
    ServiceName|contains|any:
      - "proxy"
      - "relay"
      - "capture"
    Image|endswith: '\svchost.exe'
    CommandLine|contains|any:
      - "proxy"
      - "relay"
      - "capture"
    ParentImage|endswith: '\services.exe'
    User|not_contains|any:
      - "admin"
      - "known_service_account"  # Exclude legitimate service accounts
    ServiceType|not_contains: "0x10"  # Filter out interactive services
    timeframe: last_15m               # Threshold to reduce false positives
    count(service_creation) > 5       # Alert if more than 5 events occur in 15 minutes

  # Detection 2: Suspicious DNS/LLMNR and Network Configuration Changes (Sysmon Event ID 13)
  registry_dns_modification:
    EventID: 13               # Sysmon Registry Modification Event
    TargetObject|contains|any:
      - '\Software\Policies\Microsoft\Windows NT\DNSClient'
      - '\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters'   # Additional DNS key
      - '\Software\Policies\Microsoft\Windows\LLMNR'               # Additional LLMNR key
    Details|contains: '0'
    User|endswith: SYSTEM      # Ensure it's from a privileged user context
    ParentImage|contains: '\svchost.exe'

  # Detection 3: Traffic Monitoring Commands and Known AiTM Tool Artifacts (Windows Event ID 4688, Sysmon Event ID 1)
  traffic_monitoring_commands:
    EventID:
      - 4688                  # Windows Process Creation
      - 1                     # Sysmon Process Creation
    CommandLine|contains|any:
      - "netsh interface"     # Network configuration changes
      - "powershell -command" # Check for PowerShell-based network commands
      - "Responder.py"        # Common AiTM tool
      - "Inveigh.ps1"         # Common AiTM tool
    ParentImage|endswith|any:
      - '\cmd.exe'
      - '\powershell.exe'
    User|not_contains|any:
      - "admin"
      - "service_account"     # Exclude known service accounts

  # Detection 4: Network Connection Events for High-Risk Ports and Anomalous Outbound Connections (Sysmon Event ID 3)
  high_risk_ports:
    EventID: 3               # Sysmon Network Connection Detected
    DestinationPort|contains|any:
      - "1080"               # Common proxy port
      - "8888"               # Often used for reverse proxies
      - "8080"               # Alternative HTTP port
    Image|endswith: '\svchost.exe'
    DestinationIp|not_in: "corporate_ip_range" # Exclude internal IP ranges
    User|not_contains: "admin" # Exclude legitimate admin accounts


condition:
  service_creation or registry_dns_modification or traffic_monitoring_commands or high_risk_ports

level: high
tags:
  - T1557
  - Adversary-in-the-Middle (AiTM)
